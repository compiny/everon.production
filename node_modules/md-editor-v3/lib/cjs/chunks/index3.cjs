"use strict";const o=require("vue"),N=require("@vavt/util"),f=require("./config.cjs"),p=require("./event-bus.cjs"),k=require("./dom.cjs"),ae=require("@vavt/copy2clipboard"),ie=require("markdown-it"),le=require("markdown-it-image-figures"),se=require("markdown-it-sub"),ce=require("markdown-it-sup"),de=require("./index5.cjs"),ue=require("lru-cache"),me=require("medium-zoom"),A={hljs:`${f.prefix}-hljs`,hlcss:`${f.prefix}-hlCss`,prettier:`${f.prefix}-prettier`,prettierMD:`${f.prefix}-prettierMD`,cropperjs:`${f.prefix}-cropper`,croppercss:`${f.prefix}-cropperCss`,screenfull:`${f.prefix}-screenfull`,mermaidM:`${f.prefix}-mermaid-m`,mermaid:`${f.prefix}-mermaid`,katexjs:`${f.prefix}-katex`,katexcss:`${f.prefix}-katexCss`,echarts:`${f.prefix}-echarts`},pe=(e,t,i)=>{const{editorId:n}=i,r=o.reactive({buildFinished:!1,html:""});o.watch(()=>e.modelValue,()=>{r.buildFinished=!1}),o.onMounted(()=>{p.bus.on(n,{name:p.BUILD_FINISHED,callback(h){r.buildFinished=!0,r.html=h}}),p.bus.on(n,{name:p.ON_SAVE,callback(){const h=new Promise(u=>{if(r.buildFinished)u(r.html);else{const d=s=>{u(s),p.bus.remove(n,p.BUILD_FINISHED,d)};p.bus.on(n,{name:p.BUILD_FINISHED,callback:d})}});e.onSave?e.onSave(e.modelValue,h):t.emit("onSave",e.modelValue,h)}})})},Q=(e,{editorId:t,rootRef:i,setting:n})=>{const r=f.globalConfig.editorExtensions.highlight,h=f.globalConfig.editorExtensionsAttrs.highlight;o.provide("editorId",t),o.provide("rootRef",i),o.provide("theme",o.computed(()=>e.theme)),o.provide("language",o.computed(()=>e.language)),o.provide("highlight",o.computed(()=>{const{js:d}=r,s={...f.codeCss,...r.css},{js:m,css:l={}}=h||{},a=e.codeStyleReverse&&e.codeStyleReverseList.includes(e.previewTheme)?"dark":e.theme,c=s[e.codeTheme]?s[e.codeTheme][a]:f.codeCss.atom[a],b=s[e.codeTheme]&&l[e.codeTheme]?l[e.codeTheme][a]:l.atom?l.atom[a]:{};return{js:{src:d,...m},css:{href:c,...b}}})),o.provide("showCodeRowNumber",e.showCodeRowNumber);const u=o.computed(()=>{const d={...f.staticTextDefault,...f.globalConfig.editorConfig.languageUserDefined};return N.deepMerge(N.deepClone(f.staticTextDefault["en-US"]),d[e.language]||{})});return o.provide("usedLanguageText",u),o.provide("previewTheme",o.computed(()=>e.previewTheme)),o.provide("customIcon",o.computed(()=>e.customIcon)),o.provide("setting",o.computed(()=>n?{...n}:{preview:!0,htmlPreview:!1,previewOnly:!1,pageFullscreen:!1,fullscreen:!1})),{editorId:t}},fe=(e,t)=>(o.provide("tabWidth",e.tabWidth),o.provide("disabled",o.computed(()=>e.disabled)),o.provide("showToolbarName",o.computed(()=>e.showToolbarName)),o.provide("noUploadImg",e.noUploadImg),o.provide("tableShape",o.computed(()=>e.tableShape)),o.provide("noPrettier",e.noPrettier),o.provide("codeTheme",o.computed(()=>e.codeTheme)),o.provide("updateSetting",t.updateSetting),o.provide("catalogVisible",o.computed(()=>t.catalogVisible.value)),o.provide("defToolbars",t.defToolbars),o.provide("floatingToolbars",o.computed(()=>e.floatingToolbars)),Q(e,t)),he=e=>{const{noPrettier:t,noUploadImg:i}=e,{editorExtensions:n,editorExtensionsAttrs:r}=f.globalConfig,h=t||n.prettier.prettierInstance,u=t||n.prettier.parserMarkdownInstance,d=i||n.cropper.instance;o.onMounted(()=>{if(!d){const{js:s={},css:m={}}=r.cropper||{};k.appendHandler("link",{...m,rel:"stylesheet",href:n.cropper.css,id:A.croppercss}),k.appendHandler("script",{...s,src:n.cropper.js,id:A.cropperjs})}if(!h){const{standaloneJs:s={}}=r.prettier||{};k.appendHandler("script",{...s,src:n.prettier.standaloneJs,id:A.prettier})}if(!u){const{parserMarkdownJs:s={}}=r.prettier||{};k.appendHandler("script",{...s,src:n.prettier.parserMarkdownJs,id:A.prettierMD})}})},ge=(e,t,i)=>{const{editorId:n}=i;o.onMounted(()=>{p.bus.on(n,{name:p.ERROR_CATCHER,callback:r=>{e.onError?.(r),t.emit("onError",r)}})})},ve=(e,t,i)=>{const{editorId:n}=i,r=o.reactive({pageFullscreen:e.pageFullscreen,fullscreen:!1,preview:e.preview,htmlPreview:e.preview?!1:e.htmlPreview,previewOnly:!1}),h=o.reactive({...r}),u=(m,l)=>{const a=l===void 0?!r[m]:l;switch(m){case"preview":{r.htmlPreview=!1,r.previewOnly=!1;break}case"htmlPreview":{r.preview=!1,r.previewOnly=!1;break}case"previewOnly":{a?!r.preview&&!r.htmlPreview&&(r.preview=!0):(h.preview||(r.preview=!1),h.htmlPreview||(r.htmlPreview=!1));break}}h[m]=a,r[m]=a};let d="";const s=()=>{r.pageFullscreen||r.fullscreen?document.body.style.overflow="hidden":document.body.style.overflow=d};return o.watch(()=>[r.pageFullscreen,r.fullscreen],s),o.onMounted(()=>{p.bus.on(n,{name:p.UPLOAD_IMAGE,callback(m,l){const a=c=>{p.bus.emit(n,p.REPLACE,"image",{desc:"",urls:c}),l?.()};e.onUploadImg?e.onUploadImg(m,a):t.emit("onUploadImg",m,a)}}),d=document.body.style.overflow,s()}),[r,u]},be=(e,t)=>{const{editorId:i}=t,n=o.ref(!1);return o.onMounted(()=>{p.bus.on(i,{name:p.CHANGE_CATALOG_VISIBLE,callback:r=>{r===void 0?n.value=!n.value:n.value=r}})}),n},ye=(e,t,i)=>{const{editorId:n,catalogVisible:r,setting:h,updateSetting:u,codeRef:d}=i;o.watch(()=>h.pageFullscreen,m=>{p.bus.emit(n,p.PAGE_FULL_SCREEN_CHANGED,m)}),o.watch(()=>h.fullscreen,m=>{p.bus.emit(n,p.FULL_SCREEN_CHANGED,m)}),o.watch(()=>h.preview,m=>{p.bus.emit(n,p.PREVIEW_CHANGED,m)}),o.watch(()=>h.previewOnly,m=>{p.bus.emit(n,p.PREVIEW_ONLY_CHANGED,m)}),o.watch(()=>h.htmlPreview,m=>{p.bus.emit(n,p.HTML_PREVIEW_CHANGED,m)}),o.watch(r,m=>{p.bus.emit(n,p.CATALOG_VISIBLE_CHANGED,m)});const s={on(m,l){switch(m){case"pageFullscreen":{p.bus.on(n,{name:p.PAGE_FULL_SCREEN_CHANGED,callback(a){l(a)}});break}case"fullscreen":{p.bus.on(n,{name:p.FULL_SCREEN_CHANGED,callback(a){l(a)}});break}case"preview":{p.bus.on(n,{name:p.PREVIEW_CHANGED,callback(a){l(a)}});break}case"previewOnly":{p.bus.on(n,{name:p.PREVIEW_ONLY_CHANGED,callback(a){l(a)}});break}case"htmlPreview":{p.bus.on(n,{name:p.HTML_PREVIEW_CHANGED,callback(a){l(a)}});break}case"catalog":{p.bus.on(n,{name:p.CATALOG_VISIBLE_CHANGED,callback(a){l(a)}});break}}},togglePageFullscreen(m){u("pageFullscreen",m)},toggleFullscreen(m){p.bus.emit(n,p.CHANGE_FULL_SCREEN,m)},togglePreview(m){u("preview",m)},togglePreviewOnly(m){u("previewOnly",m)},toggleHtmlPreview(m){u("htmlPreview",m)},toggleCatalog(m){p.bus.emit(n,p.CHANGE_CATALOG_VISIBLE,m)},triggerSave(){p.bus.emit(n,p.ON_SAVE)},insert(m){p.bus.emit(n,p.REPLACE,"universal",{generate:m})},focus(m){d.value?.focus(m)},rerender(){p.bus.emit(n,p.RERENDER)},getSelectedText(){return d.value?.getSelectedText()},resetHistory(){d.value?.resetHistory()},domEventHandlers(m){p.bus.emit(n,p.EVENT_LISTENER,m)},execCommand(m){p.bus.emit(n,p.REPLACE,m)},getEditorView(){return d.value?.getEditorView()}};t.expose(s)},ee=e=>{const t=o.useId();return e.id||e.editorId||`${f.prefix}-${t}`},we=(e,t,i)=>{const n=o.inject("editorId"),r=o.inject("rootRef"),h=o.inject("usedLanguageText"),u=o.inject("setting"),d=()=>{r.value.querySelectorAll(`#${n} .${f.prefix}-preview .${f.prefix}-code`).forEach(l=>{let a=-1;const c=l.querySelector(`.${f.prefix}-copy-button:not([data-processed])`);c&&(c.onclick=b=>{b.preventDefault(),clearTimeout(a);const v=(l.querySelector("input:checked + pre code")||l.querySelector("pre code")).textContent,{text:w,successTips:I,failTips:y}=h.value.copyCode;let x=I;ae(e.formatCopiedText(v||"")).catch(()=>{x=y}).finally(()=>{c.dataset.isIcon?c.dataset.tips=x:c.innerHTML=x,a=window.setTimeout(()=>{c.dataset.isIcon?c.dataset.tips=w:c.innerHTML=w},1500)})},c.setAttribute("data-processed","true"))})},s=()=>{o.nextTick(d)},m=l=>{l&&o.nextTick(d)};o.watch([t,i],s),o.watch(()=>u.value.preview,m),o.watch(()=>u.value.htmlPreview,m),o.onMounted(d)},Ee=e=>{const t=o.inject("editorId"),i=o.inject("theme"),n=o.inject("rootRef"),{editorExtensions:r,editorExtensionsAttrs:h}=f.globalConfig;let u=r.echarts.instance;const d=o.shallowRef(-1),s=()=>{!e.noEcharts&&u&&(d.value=d.value+1)};o.watch(()=>i.value,()=>{s()}),o.onMounted(()=>{if(e.noEcharts||u)return;const g=r.echarts.js;k.appendHandler("script",{...h.echarts?.js,src:g,id:A.echarts,onload(){u=window.echarts,s()}},"echarts")});let m=[],l=[],a=[];const c=(g=!1)=>{if(!m.length){g&&(l.forEach(y=>{y.dispose?.()}),a.forEach(y=>{y.disconnect?.()}),l=[],a=[]);return}const v=[],w=[],I=[];m.forEach((y,x)=>{const T=l[x],E=a[x];if(g||!y||!y.isConnected||(n?.value?!n.value.contains(y):!1)){T?.dispose?.(),E?.disconnect?.();return}v.push(y),T&&w.push(T),E&&I.push(E)}),m=v,l=w,a=I},b=()=>{c(),!e.noEcharts&&u&&Array.from(n.value.querySelectorAll(`#${t} div.${f.prefix}-echarts:not([data-processed])`)).forEach(v=>{if(v.dataset.closed==="false")return!1;try{const w=new Function(`return ${v.innerText}`)(),I=u.init(v,i.value);I.setOption(w),v.setAttribute("data-processed",""),m.push(v),l.push(I);const y=new ResizeObserver(()=>{I.resize()});y.observe(v),a.push(y)}catch(w){p.bus.emit(t,p.ERROR_CATCHER,{name:"echarts",message:w?.message,error:w})}})};return o.onBeforeUnmount(()=>{c(!0)}),{reRenderEcharts:d,replaceEcharts:b}},xe=e=>{const t=o.inject("highlight"),i=o.shallowRef(f.globalConfig.editorExtensions.highlight.instance);return o.onMounted(()=>{e.noHighlight||i.value||(k.appendHandler("link",{...t.value.css,rel:"stylesheet",id:A.hlcss}),k.appendHandler("script",{...t.value.js,id:A.hljs,onload(){i.value=window.hljs}},"hljs"))}),o.watch(()=>t.value.css,()=>{e.noHighlight||f.globalConfig.editorExtensions.highlight.instance||k.updateHandler("link",{...t.value.css,rel:"stylesheet",id:A.hlcss})}),i},Ce=e=>{const t=o.shallowRef(f.globalConfig.editorExtensions.katex.instance);return o.onMounted(()=>{if(e.noKatex||t.value)return;const{editorExtensions:i,editorExtensionsAttrs:n}=f.globalConfig;k.appendHandler("script",{...n.katex?.js,src:i.katex.js,id:A.katexjs,onload(){t.value=window.katex}},"katex"),k.appendHandler("link",{...n.katex?.css,rel:"stylesheet",href:i.katex.css,id:A.katexcss})}),t},U=new ue.LRUCache({max:1e3,ttl:6e5}),$e=e=>{const t=o.inject("editorId"),i=o.inject("theme"),n=o.inject("rootRef"),{editorExtensions:r,editorExtensionsAttrs:h,mermaidConfig:u}=f.globalConfig;let d=r.mermaid.instance;const s=o.shallowRef(-1),m=()=>{!e.noMermaid&&d&&(d.initialize(u({startOnLoad:!1,theme:i.value==="dark"?"dark":"default"})),s.value=s.value+1)};return o.watch(()=>i.value,()=>{U.clear(),m()}),o.onMounted(()=>{if(e.noMermaid||d)return;const a=r.mermaid.js;/\.mjs/.test(a)?(k.appendHandler("link",{...h.mermaid?.js,rel:"modulepreload",href:a,id:A.mermaidM}),import(a).then(c=>{d=c.default,m()}).catch(c=>{p.bus.emit(t,p.ERROR_CATCHER,{name:"mermaid",message:`Failed to load mermaid module: ${c.message}`,error:c})})):k.appendHandler("script",{...h.mermaid?.js,src:a,id:A.mermaid,onload(){d=window.mermaid,m()}},"mermaid")}),{reRenderRef:s,replaceMermaid:async()=>{if(!e.noMermaid&&d){const a=n.value.querySelectorAll(`div.${f.prefix}-mermaid`),c=document.createElement("div"),b=document.body.offsetWidth>1366?document.body.offsetWidth:1366,g=document.body.offsetHeight>768?document.body.offsetHeight:768;c.style.width=b+"px",c.style.height=g+"px",c.style.position="fixed",c.style.zIndex="-10000",c.style.top="-10000";let v=a.length;v>0&&document.body.appendChild(c),await Promise.allSettled(Array.from(a).map(w=>(async y=>{if(y.dataset.closed==="false")return!1;const x=y.innerText;let T=U.get(x);if(!T){const E=N.randomId();let R={svg:""};try{R=await d.render(E,x,c),T=await e.sanitizeMermaid(R.svg);const $=document.createElement("p");$.className=`${f.prefix}-mermaid`,$.setAttribute("data-processed",""),$.setAttribute("data-content",x),$.innerHTML=T,$.children[0]?.removeAttribute("height"),U.set(x,$.innerHTML),y.dataset.line!==void 0&&($.dataset.line=y.dataset.line),y.replaceWith($)}catch($){p.bus.emit(t,p.ERROR_CATCHER,{name:"mermaid",message:$.message,error:$})}--v===0&&c.remove()}})(w)))}}}},Ie=(e,t)=>{t=t||{};const i=3,n=t.marker||"!",r=n.charCodeAt(0),h=n.length;let u="",d="";const s=(l,a,c,b,g)=>{const v=l[a];return v.type==="admonition_open"?l[a].attrPush(["class",`${f.prefix}-admonition ${f.prefix}-admonition-${v.info}`]):v.type==="admonition_title_open"&&l[a].attrPush(["class",`${f.prefix}-admonition-title`]),g.renderToken(l,a,c)},m=l=>{const a=l.trim().split(" ",2);d="",u=a[0],a.length>1&&(d=l.substring(u.length+2))};e.block.ruler.before("code","admonition",(l,a,c,b)=>{let g,v,w,I=!1,y=l.bMarks[a]+l.tShift[a],x=l.eMarks[a];if(r!==l.src.charCodeAt(y))return!1;for(g=y+1;g<=x&&n[(g-y)%h]===l.src[g];g++);const T=Math.floor((g-y)/h);if(T!==i)return!1;g-=(g-y)%h;const E=l.src.slice(y,g),R=l.src.slice(g,x);if(m(R),b)return!0;for(v=a;v++,!(v>=c||(y=l.bMarks[v]+l.tShift[v],x=l.eMarks[v],y<x&&l.sCount[v]<l.blkIndent));)if(r===l.src.charCodeAt(y)&&!(l.sCount[v]-l.blkIndent>=4)){for(g=y+1;g<=x&&n[(g-y)%h]===l.src[g];g++);if(!(Math.floor((g-y)/h)<T)&&(g-=(g-y)%h,g=l.skipSpaces(g),!(g<x))){I=!0;break}}const $=l.parentType,H=l.lineMax;return l.parentType="root",l.lineMax=v,w=l.push("admonition_open","div",1),w.markup=E,w.block=!0,w.info=u,w.map=[a,v],d&&(w=l.push("admonition_title_open","p",1),w.markup=E+" "+u,w.map=[a,v],w=l.push("inline","",0),w.content=d,w.map=[a,l.line-1],w.children=[],w=l.push("admonition_title_close","p",-1),w.markup=E+" "+u),l.md.block.tokenize(l,a+1,v),w=l.push("admonition_close","div",-1),w.markup=l.src.slice(y,g),w.block=!0,l.parentType=$,l.lineMax=H,l.line=v+(I?1:0),!0},{alt:["paragraph","reference","blockquote","list"]}),e.renderer.rules.admonition_open=s,e.renderer.rules.admonition_title_open=s,e.renderer.rules.admonition_title_close=s,e.renderer.rules.admonition_close=s},z=(e,t)=>{const i=e.attrs?e.attrs.slice():[];return t.forEach(n=>{const r=e.attrIndex(n[0]);r<0?i.push(n):(i[r]=i[r].slice(),i[r][1]+=` ${n[1]}`)}),i},Te=(e,t)=>{const i=e.renderer.rules.fence,n=e.utils.unescapeAll,r=/\[(\w*)(?::([\w ]*))?\]/,h=/::(open|close)/,u=a=>a.info?n(a.info).trim():"",d=a=>{const c=u(a),[b=null,g=""]=(r.exec(c)||[]).slice(1);return[b,g]},s=a=>{const c=u(a);return c?c.split(/(\s+)/g)[0]:""},m=a=>{const c=a.info.match(h)||[],b=c[1]==="open"||c[1]!=="close"&&t.codeFoldable&&a.content.trim().split(`
`).length<t.autoFoldThreshold,g=c[1]||t.codeFoldable?"details":"div",v=c[1]||t.codeFoldable?"summary":"div";return{open:b,tagContainer:g,tagHeader:v}},l=(a,c,b,g,v)=>{if(a[c].hidden)return"";const w=t.usedLanguageTextRef.value?.copyCode.text,I=t.customIconRef.value.copy||w,y=!!t.customIconRef.value.copy,x=`<span class="${f.prefix}-collapse-tips">${k.StrIcon("collapse-tips",t.customIconRef.value)}</span>`,[T]=d(a[c]);if(T===null){const{open:C,tagContainer:S,tagHeader:G}=m(a[c]),F=[["class",`${f.prefix}-code`]];C&&F.push(["open",""]);const W={attrs:z(a[c],F)};a[c].info=a[c].info.replace(h,"");const O=i(a,c,b,g,v);return`
        <${S} ${v.renderAttrs(W)}>
          <${G} class="${f.prefix}-code-head">
            <div class="${f.prefix}-code-flag"><span></span><span></span><span></span></div>
            <div class="${f.prefix}-code-action">
              <span class="${f.prefix}-code-lang">${e.utils.escapeHtml(a[c].info.trim())}</span>
              <span class="${f.prefix}-copy-button" data-tips="${w}"${y?" data-is-icon=true":""}>${I}</span>
              ${t.extraTools instanceof Function?t.extraTools({lang:a[c].info.trim()}):t.extraTools||""}
              ${S==="details"?x:""}
            </div>
          </${G}>
          ${O}
        </${S}>
      `}let E,R,$,H,M="",L="",P="";const{open:D,tagContainer:_,tagHeader:j}=m(a[c]),B=[["class",`${f.prefix}-code`]];D&&B.push(["open",""]);const V={attrs:z(a[c],B)};for(let C=c;C<a.length&&(E=a[C],[R,$]=d(E),R===T);C++){E.info=E.info.replace(r,"").replace(h,""),E.hidden=!0;const S=`${f.prefix}-codetab-${t.editorId}-${c}-${C-c}`;H=C-c>0?"":"checked",M+=`
        <li>
          <input
            type="radio"
            id="label-${f.prefix}-codetab-label-1-${t.editorId}-${c}-${C-c}"
            name="${f.prefix}-codetab-label-${t.editorId}-${c}"
            class="${S}"
            ${H}
          >
          <label
            for="label-${f.prefix}-codetab-label-1-${t.editorId}-${c}-${C-c}"
            onclick="this.getRootNode().querySelectorAll('.${S}').forEach(e => e.click())"
          >
            ${e.utils.escapeHtml($||s(E))}
          </label>
        </li>`,L+=`
        <div role="tabpanel">
          <input
            type="radio"
            name="${f.prefix}-codetab-pre-${t.editorId}-${c}"
            class="${S}"
            ${H}
            role="presentation">
          ${i(a,C,b,g,v)}
        </div>`,P+=`
        <input
          type="radio"
          name="${f.prefix}-codetab-lang-${t.editorId}-${c}"
          class="${S}"
          ${H}
          role="presentation">
        <span class=${f.prefix}-code-lang role="note">${e.utils.escapeHtml(s(E))}</span>`}return`
      <${_} ${v.renderAttrs(V)}>
        <${j} class="${f.prefix}-code-head">
          <div class="${f.prefix}-code-flag">
            <ul class="${f.prefix}-codetab-label" role="tablist">${M}</ul>
          </div>
          <div class="${f.prefix}-code-action">
            <span class="${f.prefix}-codetab-lang">${P}</span>
            <span class="${f.prefix}-copy-button" data-tips="${w}"${y?" data-is-icon=true":""}>${I}</span>
            ${t.extraTools instanceof Function?t.extraTools({lang:a[c].info.trim()}):t.extraTools||""}
            ${_==="details"?x:""}
          </div>
        </${j}>
        ${L}
      </${_}>
    `};e.renderer.rules.fence=l,e.renderer.rules.code_block=l},ke=(e,t)=>{const i=e.renderer.rules.fence.bind(e.renderer.rules);e.renderer.rules.fence=(n,r,h,u,d)=>{const s=n[r],m=s.content.trim();if(s.info==="echarts"){if(s.attrSet("class",`${f.prefix}-echarts`),s.attrSet("data-echarts-theme",t.themeRef.value),s.map&&s.level===0){const l=s.map[1]-1,c=!!u.srcLines[l]?.trim()?.startsWith("```");s.attrSet("data-closed",`${c}`),s.attrSet("data-line",String(s.map[0]))}return`<div ${d.renderAttrs(s)} style="width: 100%; aspect-ratio: 4 / 3;">${e.utils.escapeHtml(m)}</div>`}return i(n,r,h,u,d)}},Se=(e,t)=>{e.renderer.rules.heading_open=(i,n)=>{const r=i[n],h=i[n+1].children?.reduce((d,s)=>d+(["text","code_inline","math_inline"].includes(s.type)&&s.content||""),"")||"",u=r.markup.length;return t.headsRef.value.push({text:h,level:u,line:r.map[0],currentToken:r,nextToken:i[n+1]}),r.map&&r.level===0&&r.attrSet("id",t.mdHeadingId({text:h,level:u,index:t.headsRef.value.length,currentToken:r,nextToken:i[n+1]})),e.renderer.renderToken(i,n,t)},e.renderer.rules.heading_close=(i,n,r,h,u)=>u.renderToken(i,n,r)},K={block:[{open:"$$",close:"$$"},{open:"\\[",close:"\\]"}],inline:[{open:"$$",close:"$$"},{open:"$",close:"$"},{open:"\\[",close:"\\]"},{open:"\\(",close:"\\)"}]},Re=e=>(t,i)=>{const n=e.delimiters;let r,h,u;for(const d of n)if(t.src.startsWith(d.open,t.pos)){const s=t.pos+d.open.length;for(r=s;(r=t.src.indexOf(d.close,r))!==-1;){for(u=r-1;t.src[u]==="\\";)u-=1;if((r-u)%2===1)break;r+=d.close.length}if(r===-1)return i||(t.pending+=d.open),t.pos=s,!0;if(r-s===0)return i||(t.pending+=d.open+d.close),t.pos=s+d.close.length,!0;if(!i){const m=t.src.slice(s,r);h=t.push("math_inline","math",0),h.markup=d.open,h.content=m}return t.pos=r+d.close.length,!0}return!1},Ae=e=>(t,i,n,r)=>{const h=e.delimiters;let u,d,s,m,l=!1,a=t.bMarks[i]+t.tShift[i],c=t.eMarks[i];for(const b of h)if(t.src.slice(a,a+b.open.length)===b.open&&t.src.slice(c-b.close.length,c)===b.close){if(a+=b.open.length,u=t.src.slice(a,c),r)return!0;for(u.trim().slice(-b.close.length)===b.close&&(u=u.trim().slice(0,-b.close.length),l=!0),s=i;!l&&(s++,!(s>=n||(a=t.bMarks[s]+t.tShift[s],c=t.eMarks[s],a<c&&t.tShift[s]<t.blkIndent)));)t.src.slice(a,c).trim().slice(-b.close.length)===b.close&&(m=t.src.slice(0,c).lastIndexOf(b.close),d=t.src.slice(a,m),l=!0);t.line=s+1;const g=t.push("math_block","math",0);return g.block=!0,g.content=(u&&u.trim()?u+`
`:"")+t.getLines(i+1,s,t.tShift[i],!0)+(d&&d.trim()?d:""),g.map=[i,t.line],g.markup=b.open,!0}return!1},He=(e,{katexRef:t,inlineDelimiters:i,blockDelimiters:n})=>{const r=(u,d,s,m,l)=>{const a=u[d],c={attrs:z(a,[["class",`${f.prefix}-katex-inline`]])};if(t.value){const b=t.value.renderToString(a.content,f.globalConfig.katexConfig({throwOnError:!1}));return`<span ${l.renderAttrs(c)} data-processed>${b}</span>`}else return`<span ${l.renderAttrs(c)}>${a.content}</span>`},h=(u,d,s,m,l)=>{const a=u[d],c={attrs:z(a,[["class",`${f.prefix}-katex-block`]])};if(t.value){const b=t.value.renderToString(a.content,f.globalConfig.katexConfig({throwOnError:!1,displayMode:!0}));return`<p ${l.renderAttrs(c)} data-processed>${b}</p>`}else return`<p ${l.renderAttrs(c)}>${a.content}</p>`};e.inline.ruler.before("escape","math_inline",Re({delimiters:i||K.inline})),e.block.ruler.after("blockquote","math_block",Ae({delimiters:n||K.block}),{alt:["paragraph","reference","blockquote","list"]}),e.renderer.rules.math_inline=r,e.renderer.rules.math_block=h},Me=(e,t)=>{const i=e.renderer.rules.fence.bind(e.renderer.rules);e.renderer.rules.fence=(n,r,h,u,d)=>{const s=n[r],m=s.content.trim();if(s.info==="mermaid"){if(s.attrSet("class",`${f.prefix}-mermaid`),s.attrSet("data-mermaid-theme",t.themeRef.value),s.map&&s.level===0){const a=s.map[1]-1,b=!!u.srcLines[a]?.trim()?.startsWith("```");s.attrSet("data-closed",`${b}`),s.attrSet("data-line",String(s.map[0]))}const l=U.get(m);return l?(s.attrSet("data-processed",""),s.attrSet("data-content",m),`<p ${d.renderAttrs(s)}>${l}</p>`):`<div ${d.renderAttrs(s)}>${e.utils.escapeHtml(m)}</div>`}return i(n,r,h,u,d)}},Z=(e,t,i)=>{const n=e.attrIndex(t),r=[t,i];n<0?e.attrPush(r):(e.attrs=e.attrs||[],e.attrs[n]=r)},Fe=e=>e.type==="inline",Le=e=>e.type==="paragraph_open",Pe=e=>e.type==="list_item_open",_e=e=>e.content.indexOf("[ ] ")===0||e.content.indexOf("[x] ")===0||e.content.indexOf("[X] ")===0,Ne=(e,t)=>Fe(e[t])&&Le(e[t-1])&&Pe(e[t-2])&&_e(e[t]),je=(e,t)=>{const i=e[t].level-1;for(let n=t-1;n>=0;n--)if(e[n].level===i)return n;return-1},Oe=e=>{const t=new e("html_inline","",0);return t.content="<label>",t},De=e=>{const t=new e("html_inline","",0);return t.content="</label>",t},Be=(e,t,i)=>{const n=new i("html_inline","",0);return n.content='<label class="task-list-item-label" for="'+t+'">'+e+"</label>",n.attrs=[["for",t]],n},Ve=(e,t,i)=>{const n=new t("html_inline","",0),r=i.enabled?" ":' disabled="" ';return e.content.indexOf("[ ] ")===0?n.content='<input class="task-list-item-checkbox"'+r+'type="checkbox">':(e.content.indexOf("[x] ")===0||e.content.indexOf("[X] ")===0)&&(n.content='<input class="task-list-item-checkbox" checked=""'+r+'type="checkbox">'),n},Ge=(e,t,i)=>{if(e.children=e.children||[],e.children.unshift(Ve(e,t,i)),e.children[1].content=e.children[1].content.slice(3),e.content=e.content.slice(3),i.label)if(i.labelAfter){e.children.pop();const n="task-item-"+Math.ceil(Math.random()*(1e4*1e3)-1e3);e.children[0].content=e.children[0].content.slice(0,-1)+' id="'+n+'">',e.children.push(Be(e.content,n,t))}else e.children.unshift(Oe(t)),e.children.push(De(t))},Ue=(e,t={})=>{e.core.ruler.after("inline","github-task-lists",i=>{const n=i.tokens;for(let r=2;r<n.length;r++)Ne(n,r)&&(Ge(n[r],i.Token,t),Z(n[r-2],"class","task-list-item"+(t.enabled?" enabled":" ")),Z(n[je(n,r-2)],"class","contains-task-list"))})},qe=e=>{e.core.ruler.push("init-line-number",t=>(t.tokens.forEach(i=>{i.map&&(i.attrs||(i.attrs=[]),i.attrs.push(["data-line",i.map[0].toString()]))}),!0))},ze=(e,t)=>{const{editorConfig:i,markdownItConfig:n,markdownItPlugins:r,editorExtensions:h}=f.globalConfig,u=o.inject("editorId"),d=o.inject("language"),s=o.inject("usedLanguageText"),m=o.inject("showCodeRowNumber"),l=o.inject("theme"),a=o.inject("customIcon"),c=o.inject("rootRef"),b=o.inject("setting"),g=o.ref([]),v=xe(e),w=Ce(e),{reRenderRef:I,replaceMermaid:y}=$e(e),{reRenderEcharts:x,replaceEcharts:T}=Ee(e),E=ie({html:!0,breaks:!0,linkify:!0});n(E,{editorId:u});const R=[{type:"image",plugin:le,options:{figcaption:!0,classes:"md-zoom"}},{type:"admonition",plugin:Ie,options:{}},{type:"taskList",plugin:Ue,options:{}},{type:"heading",plugin:Se,options:{mdHeadingId:e.mdHeadingId,headsRef:g}},{type:"code",plugin:Te,options:{editorId:u,usedLanguageTextRef:s,codeFoldable:e.codeFoldable,autoFoldThreshold:e.autoFoldThreshold,customIconRef:a}},{type:"sub",plugin:se,options:{}},{type:"sup",plugin:ce,options:{}}];e.noKatex||R.push({type:"katex",plugin:He,options:{katexRef:w}}),e.noMermaid||R.push({type:"mermaid",plugin:Me,options:{themeRef:l}}),e.noEcharts||R.push({type:"echarts",plugin:ke,options:{themeRef:l}}),r(R,{editorId:u}).forEach(C=>{E.use(C.plugin,C.options)});const $=E.options.highlight;E.set({highlight:(C,S,G)=>{if($){const O=$(C,S,G);if(O)return O}let F;!e.noHighlight&&v.value?v.value.getLanguage(S)?F=v.value.highlight(C,{language:S,ignoreIllegals:!0}).value:F=v.value.highlightAuto(C).value:F=E.utils.escapeHtml(C);const W=m?de.generateCodeRowNumber(F.replace(/^\n+|\n+$/g,""),C.replace(/^\n+|\n+$/g,"")):`<span class="${f.prefix}-code-block">${F.replace(/^\n+|\n+$/g,"")}</span>`;return`<pre><code class="language-${S}" language=${S}>${W}</code></pre>`}}),qe(E);const H=o.ref(`_article-key_${N.randomId()}`),M=o.ref(e.sanitize(E.render(e.modelValue,{srcLines:e.modelValue.split(`
`)})));let L=()=>{},P=()=>{};const D=()=>{const C=c.value?.querySelectorAll(`#${u} p.${f.prefix}-mermaid:not([data-closed=false])`);P(),P=k.copyMermaid(C,{customIcon:a.value}),h.mermaid?.enableZoom&&(L(),L=k.zoomMermaid(C,{customIcon:a.value}))},_=()=>{p.bus.emit(u,p.BUILD_FINISHED,M.value),e.onHtmlChanged(M.value),e.onGetCatalog(g.value),p.bus.emit(u,p.CATALOG_CHANGED,g.value),o.nextTick(()=>{y().then(D),T()})},j=()=>{g.value=[],M.value=e.sanitize(E.render(e.modelValue,{srcLines:e.modelValue.split(`
`)}))},B=o.computed(()=>(e.noKatex||!!w.value)&&(e.noHighlight||!!v.value));let V=-1;return o.watch([o.toRef(e,"modelValue"),B,I,d],()=>{V=window.setTimeout(()=>{j()},t?0:i.renderDelay)}),o.watch(()=>b.value.preview,()=>{b.value.preview&&o.nextTick(()=>{y().then(D),T(),p.bus.emit(u,p.CATALOG_CHANGED,g.value)})}),o.watch([M,x],()=>{_()}),o.onMounted(_),o.onMounted(()=>{p.bus.on(u,{name:p.PUSH_CATALOG,callback(){p.bus.emit(u,p.CATALOG_CHANGED,g.value)}}),p.bus.on(u,{name:p.RERENDER,callback:()=>{H.value=`_article-key_${N.randomId()}`,j()}})}),o.onBeforeUnmount(()=>{L(),P(),clearTimeout(V)}),{html:M,key:H}},We=(e,t)=>{const i=o.inject("editorId"),n=o.inject("setting"),{noImgZoomIn:r}=e,h=N.debounce(()=>{const u=document.querySelectorAll(`#${i}-preview img:not(.not-zoom):not(.medium-zoom-image)`);u.length!==0&&me(u,{background:"#00000073"})});o.onMounted(async()=>{!r&&n.value.preview&&await h()}),o.watch([t,()=>n.value.preview],async()=>{!r&&n.value.preview&&await h()})},J={checked:{regexp:/- \[x\]/,value:"- [ ]"},unChecked:{regexp:/- \[\s\]/,value:"- [x]"}},Ke=(e,t)=>{const i=o.inject("editorId"),n=o.inject("rootRef");let r=()=>{};const h=()=>{if(!n.value)return!1;const u=n.value.querySelectorAll(".task-list-item.enabled"),d=s=>{s.preventDefault();const m=s.target.checked?"unChecked":"checked",l=s.target.parentElement?.dataset.line;if(!l)return;const a=Number(l),c=e.modelValue.split(`
`),b=c[Number(a)].replace(J[m].regexp,J[m].value);e.previewOnly?(c[Number(a)]=b,e.onChange(c.join(`
`))):p.bus.emit(i,p.TASK_STATE_CHANGED,a+1,b)};u.forEach(s=>{s.addEventListener("click",d)}),r=()=>{u.forEach(s=>{s.removeEventListener("click",d)})}};o.onBeforeUnmount(()=>{r()}),o.watch([t],()=>{r(),o.nextTick(h)},{immediate:!0})},Ze=(e,t,i)=>{const n=o.inject("setting"),r=()=>{o.nextTick(()=>{e.onRemount?.()})},h=u=>{u&&r()};o.watch([t,i],r),o.watch(()=>n.value.preview,h),o.watch(()=>n.value.htmlPreview,h),o.onMounted(r)},te={modelValue:{type:String,default:""},onChange:{type:Function,default:()=>{}},onHtmlChanged:{type:Function,default:()=>{}},onGetCatalog:{type:Function,default:()=>{}},mdHeadingId:{type:Function,default:()=>""},noMermaid:{type:Boolean,default:!1},sanitize:{type:Function,default:e=>e},noKatex:{type:Boolean,default:!1},formatCopiedText:{type:Function,default:e=>e},noHighlight:{type:Boolean,default:!1},previewOnly:{type:Boolean,default:!1},noImgZoomIn:{type:Boolean},sanitizeMermaid:{type:Function},codeFoldable:{type:Boolean},autoFoldThreshold:{type:Number},onRemount:{type:Function},noEcharts:{type:Boolean}},Je={...te,updateModelValue:{type:Function,default:()=>{}},placeholder:{type:String,default:""},scrollAuto:{type:Boolean},autofocus:{type:Boolean},readonly:{type:Boolean},maxlength:{type:Number},autoDetectCode:{type:Boolean},onBlur:{type:Function,default:()=>{}},onFocus:{type:Function,default:()=>{}},completions:{type:Array},onInput:{type:Function},onDrop:{type:Function,default:()=>{}},inputBoxWidth:{type:String},oninputBoxWidthChange:{type:Function},transformImgUrl:{type:Function,default:e=>e},catalogLayout:{type:String},catalogMaxDepth:{type:Number}},X=e=>{const i=new DOMParser().parseFromString(e,"text/html");return Array.from(i.body.childNodes)},Xe=(e,t)=>e.nodeType!==t.nodeType?!1:e.nodeType===Node.TEXT_NODE||e.nodeType===Node.COMMENT_NODE?e.textContent===t.textContent:e.nodeType===Node.ELEMENT_NODE?e.outerHTML===t.outerHTML:e.isEqualNode?e.isEqualNode(t):!1,Y=o.defineComponent({name:"UpdateOnDemand",props:{html:{type:String,required:!0}},setup(e){const t=o.inject("editorId"),i=o.inject("previewTheme"),n=o.inject("showCodeRowNumber"),r=o.ref(),h=e.html,u=(d,s)=>{if(!r.value)return;const m=r.value,l=Array.from(m.childNodes),a=Math.min(d.length,s.length);let c=-1;for(let g=0;g<a;g++)if(!Xe(d[g],s[g])){c=g;break}if(c===-1)if(s.length>d.length)c=d.length;else if(d.length>s.length)c=s.length;else return;const b=Math.min(c,l.length);for(let g=l.length-1;g>=b;g--)l[g].remove();for(let g=c;g<d.length;g++)m.appendChild(d[g].cloneNode(!0))};return o.watch(()=>e.html,(d,s)=>{const m=X(d),l=X(s||"");u(m,l)}),()=>o.createVNode("div",{id:`${t}-preview`,class:[`${f.prefix}-preview`,`${i?.value}-theme`,n&&`${f.prefix}-scrn`],innerHTML:h,ref:r},null)}}),ne=o.defineComponent({name:"ContentPreview",props:te,setup(e){const t=o.inject("editorId"),i=o.inject("setting"),{html:n,key:r}=ze(e,e.previewOnly);return we(e,n,r),We(e,n),Ke(e,n),Ze(e,n,r),()=>o.createVNode(o.Fragment,null,[i.value.preview&&(e.previewOnly?o.createVNode(Y,{key:r.value,html:n.value},null):o.createVNode("div",{id:`${t}-preview-wrapper`,class:`${f.prefix}-preview-wrapper`,key:"content-preview-wrapper"},[o.createVNode(Y,{key:r.value,html:n.value},null)])),i.value.htmlPreview&&o.createVNode("div",{id:`${t}-html-wrapper`,class:`${f.prefix}-preview-wrapper`,key:"html-preview-wrapper"},[o.createVNode("div",{class:`${f.prefix}-html`},[n.value])])])}}),Ye=({text:e})=>e,oe={modelValue:{type:String,default:""},onChange:{type:Function,default:void 0},theme:{type:String,default:"light"},class:{type:String,default:""},language:{type:String,default:"zh-CN"},onHtmlChanged:{type:Function,default:void 0},onGetCatalog:{type:Function,default:void 0},editorId:{type:String,default:void 0},id:{type:String,default:void 0},showCodeRowNumber:{type:Boolean,default:!0},previewTheme:{type:String,default:"default"},style:{type:Object,default:()=>({})},mdHeadingId:{type:Function,default:Ye},sanitize:{type:Function,default:e=>e},noMermaid:{type:Boolean,default:!1},noKatex:{type:Boolean,default:!1},codeTheme:{type:String,default:"atom"},formatCopiedText:{type:Function,default:e=>e},codeStyleReverse:{type:Boolean,default:!0},codeStyleReverseList:{type:Array,default:["default","mk-cute"]},noHighlight:{type:Boolean,default:!1},noImgZoomIn:{type:Boolean,default:!1},customIcon:{type:Object,default:{}},sanitizeMermaid:{type:Function,default:e=>Promise.resolve(e)},codeFoldable:{type:Boolean,default:!0},autoFoldThreshold:{type:Number,default:30},onRemount:{type:Function,default:void 0},noEcharts:{type:Boolean,default:!1}},Qe={...oe,onSave:{type:Function,default:void 0},onUploadImg:{type:Function,default:void 0},pageFullscreen:{type:Boolean,default:!1},preview:{type:Boolean,default:!0},htmlPreview:{type:Boolean,default:!1},toolbars:{type:Array,default:f.allToolbar},floatingToolbars:{type:Array,default:[]},toolbarsExclude:{type:Array,default:[]},noPrettier:{type:Boolean,default:!1},tabWidth:{type:Number,default:2},tableShape:{type:Array,default:[6,4]},placeholder:{type:String,default:""},defToolbars:{type:[String,Object],default:void 0},onError:{type:Function,default:void 0},footers:{type:Array,default:f.allFooter},scrollAuto:{type:Boolean,default:!0},defFooters:{type:[String,Object],default:void 0},noUploadImg:{type:Boolean,default:!1},autoFocus:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},readOnly:{type:Boolean,default:!1},maxLength:{type:Number,default:void 0},autoDetectCode:{type:Boolean,default:!1},onBlur:{type:Function,default:void 0},onFocus:{type:Function,default:void 0},completions:{type:Array,default:void 0},showToolbarName:{type:Boolean,default:!1},onInput:{type:Function,default:void 0},onDrop:{type:Function,default:void 0},inputBoxWidth:{type:String,default:"50%"},oninputBoxWidthChange:{type:Function,default:void 0},transformImgUrl:{type:Function,default:e=>e},catalogLayout:{type:String,default:"fixed"},catalogMaxDepth:{type:Number,default:void 0}},re=["onHtmlChanged","onGetCatalog","onChange","onRemount","update:modelValue"],et=[...re,"onSave","onUploadImg","onError","onBlur","onFocus","onInput","onDrop","oninputBoxWidthChange"],tt=(e,t,i)=>{const{editorId:n}=i,r={rerender(){p.bus.emit(n,p.RERENDER)}};t.expose(r)},q=o.defineComponent({name:"MdPreview",props:oe,emits:re,setup(e,t){const{noKatex:i,noMermaid:n,noHighlight:r}=e,h=o.ref(),u=ee(e);return Q(e,{rootRef:h,editorId:u}),tt(e,t,{editorId:u}),o.onBeforeUnmount(()=>{p.bus.clear(u)}),()=>o.createVNode("div",{id:u,class:[f.prefix,e.class,e.theme==="dark"&&`${f.prefix}-dark`,`${f.prefix}-previewOnly`],style:e.style,ref:h},[o.createVNode(ne,{modelValue:e.modelValue,onChange:d=>{e.onChange?.(d),t.emit("onChange",d),t.emit("update:modelValue",d)},onHtmlChanged:d=>{e.onHtmlChanged?.(d),t.emit("onHtmlChanged",d)},onGetCatalog:d=>{e.onGetCatalog?.(d),t.emit("onGetCatalog",d)},mdHeadingId:e.mdHeadingId,noMermaid:n,sanitize:e.sanitize,noKatex:i,formatCopiedText:e.formatCopiedText,noHighlight:r,noImgZoomIn:e.noImgZoomIn,previewOnly:!0,sanitizeMermaid:e.sanitizeMermaid,codeFoldable:e.codeFoldable,autoFoldThreshold:e.autoFoldThreshold,onRemount:()=>{e.onRemount?.(),t.emit("onRemount")},noEcharts:e.noEcharts},null)])}});q.install=e=>(e.component(q.name,q),e);exports.CDN_IDS=A;exports.ContentPreview=ne;exports.MdPreview=q;exports.contentProps=Je;exports.editorEmits=et;exports.editorProps=Qe;exports.useCatalog=be;exports.useConfig=ve;exports.useEditorId=ee;exports.useErrorCatcher=ge;exports.useExpansion=he;exports.useExpose=ye;exports.useOnSave=pe;exports.useProvide=fe;
