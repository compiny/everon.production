"use strict";const n=require("vue"),D=require("./config.cjs"),L=require("./event-bus.cjs"),G=require("./index5.cjs"),W=require("@vavt/util"),P=`.${D.prefix}-preview > [data-line]`,V=(e,t)=>+getComputedStyle(e).getPropertyValue(t).replace("px",""),j=(e,t)=>{const C=W.debounce(()=>{e.removeEventListener("scroll",c),e.addEventListener("scroll",c),t.removeEventListener("scroll",c),t.addEventListener("scroll",c)},50),c=i=>{const k=e.clientHeight,I=t.clientHeight,h=e.scrollHeight,s=t.scrollHeight,g=(h-k)/(s-I);i.target===e?(t.removeEventListener("scroll",c),t.scrollTo({top:e.scrollTop/g}),C()):(e.removeEventListener("scroll",c),e.scrollTo({top:t.scrollTop*g}),C())};return[()=>{C().finally(()=>{e.dispatchEvent(new Event("scroll"))})},()=>{e.removeEventListener("scroll",c),t.removeEventListener("scroll",c)}]},U=(e,t,C)=>{const{view:c}=C,i=W.createSmoothScroll(),k=f=>c.lineBlockAt(c.state.doc.line(f+1).from).top,I=f=>c.lineBlockAt(c.state.doc.line(f+1).from).bottom;let h=[],s=[],g=[];const S=()=>{h=[],s=Array.from(t.querySelectorAll(P)),g=s.map(d=>Number(d.dataset.line));const f=[...g],{lines:p}=c.state.doc;let l=f.shift()||0,o=f.shift()||p;for(let d=0;d<p;d++)d===o&&(l=d,o=f.shift()||p),h.push({start:l,end:o-1})},N=(f,p)=>{let l=1;for(let o=s.length-1;o-1>=0;o--){const d=s[o],a=s[o-1];if(d.offsetTop+d.offsetHeight>p&&a.offsetTop<p){l=Number(a.dataset.line);break}}for(let o=h.length-1;o>=0;o--){const d=I(h[o].end),a=k(h[o].start);if(d>f&&a<=f){l=l<h[o].start?l:h[o].start;break}}return l};let x=0,R=0;const $=()=>{if(R!==0)return!1;x++;const{scrollDOM:f,contentHeight:p}=c;let l=V(t,"padding-top");const o=c.lineBlockAtHeight(f.scrollTop),{number:d}=c.state.doc.lineAt(o.from),a=h[d-1];if(!a)return!1;let m=1;const v=t.querySelector(`[data-line="${a.start}"]`)||t.firstElementChild?.firstElementChild,r=t.querySelector(`[data-line="${a.end+1}"]`)||t.lastElementChild?.lastElementChild,E=f.scrollHeight-f.clientHeight,b=t.scrollHeight-t.clientHeight;let u=k(a.start),A=I(a.end),y=v.offsetTop,M=r.offsetTop-y;u===0&&(y=0,v===r?(l=0,A=p-f.offsetHeight,M=b):M=r.offsetTop),m=(f.scrollTop-u)/(A-u);const O=r==t.lastElementChild?.lastElementChild?r.offsetTop+r.clientHeight:r.offsetTop;if(A>=E||O>b){const H=N(E,b);u=k(H),m=(f.scrollTop-u)/(E-u);const q=t.querySelector(`[data-line="${H}"]`);u>0&&q&&(y=q.offsetTop),M=b-y+V(t,"padding-top")}const T=y-l+M*m;i(t,T,()=>{x--})},B=()=>{if(x!==0)return;R++;const{scrollDOM:f}=c,p=t.scrollTop,l=t.scrollHeight,o=f.scrollHeight-f.clientHeight,d=t.scrollHeight-t.clientHeight;let a=t.firstElementChild?.firstElementChild,m=t.firstElementChild?.lastElementChild;if(g.length>0){let O=Math.ceil(g[g.length-1]*(p/l)),T=g.findLastIndex(H=>H<=O);T=T===-1?0:T,O=g[T];for(let H=T;H>=0&&H<g.length;)if(s[H].offsetTop>p){if(H-1>=0){H--;continue}O=-1,T=H;break}else{if(H+1<g.length&&s[H+1].offsetTop<p){H++;continue}O=g[H],T=H;break}switch(T){case-1:{a=t.firstElementChild?.firstElementChild,m=s[T];break}case g.length-1:{a=s[T],m=t.firstElementChild?.lastElementChild;break}default:a=s[T],m=s[T+1===s.length?T:T+1]}}let v=a===t.firstElementChild?.firstElementChild?0:a.offsetTop-V(a,"margin-top"),r=m.offsetTop,E=0;const{start:b,end:u}=h[Number(a.dataset.line||0)];let A=k(b);const y=k(u+1===c.state.doc.lines?u:u+1);let M=0;if(y>o||m.offsetTop+m.offsetHeight>d){const O=N(o,d),T=t.querySelector(`[data-line="${O}"]`);v=T?T.offsetTop-V(T,"margin-top"):v,A=k(O),E=(p-v)/(d-v),M=o-A}else a===t.firstElementChild?.firstElementChild?(a===m&&(r=m.offsetTop+m.offsetHeight+ +getComputedStyle(m).marginBottom.replace("px","")),M=y,E=Math.max(p/r,0)):(E=Math.max((p-v)/(r-v),0),M=y-A);i(e,A+M*E,()=>{R--})},w=f=>{const{scrollDOM:p,contentHeight:l}=c,o=p.clientHeight;if(l<=o||t.firstElementChild.clientHeight<=t.clientHeight||c.state.doc.lines<=h[h.length-1]?.end)return!1;f.target===e?$():B()};return[()=>{S(),e.addEventListener("scroll",w),t.addEventListener("scroll",w),e.dispatchEvent(new Event("scroll"))},()=>{e.removeEventListener("scroll",w),t.removeEventListener("scroll",w)}]},z={tocItem:{type:Object,default:()=>({})},mdHeadingId:{type:Function,default:()=>{}},onActive:{type:Function,default:()=>{}},onClick:{type:Function,default:()=>{}},scrollElementOffsetTop:{type:Number,default:0}},F=n.defineComponent({props:z,setup(e){const t=n.inject("scrollElementRef"),C=n.inject("roorNodeRef"),c=n.ref();return n.watch(()=>e.tocItem.active,i=>{i&&e.onActive(e.tocItem,c.value)}),n.onMounted(()=>{e.tocItem.active&&e.onActive(e.tocItem,c.value)}),()=>{const{tocItem:i,mdHeadingId:k,onClick:I,scrollElementOffsetTop:h}=e;return n.createVNode("div",{ref:c,class:[`${D.prefix}-catalog-link`,i.active&&`${D.prefix}-catalog-active`],onClick:s=>{if(s.stopPropagation(),I(s,i),s.defaultPrevented)return;const g=k({text:i.text,level:i.level,index:i.index,currentToken:i.currentToken,nextToken:i.nextToken}),S=C.value.getElementById(g),N=t.value;if(S&&N){let x=S.offsetParent,R=S.offsetTop;if(N.contains(x))for(;x&&N!=x;)R+=x?.offsetTop,x=x?.offsetParent;const $=S.previousElementSibling;let B=0;$||(B=V(S,"margin-top")),N?.scrollTo({top:R-h-B,behavior:"smooth"})}}},[n.createVNode("span",{title:i.text},[i.text]),i.children&&i.children.length>0&&n.createVNode("div",{class:`${D.prefix}-catalog-wrapper`},[i.children.map(s=>n.createVNode(F,{mdHeadingId:k,key:`${i.text}-link-${s.level}-${s.text}`,tocItem:s,onActive:e.onActive,onClick:I,scrollElementOffsetTop:h},null))])])}}}),J={editorId:{type:String,default:void 0},class:{type:String,default:""},mdHeadingId:{type:Function,default:({text:e})=>e},scrollElement:{type:[String,Object],default:void 0},theme:{type:String,default:"light"},offsetTop:{type:Number,default:20},scrollElementOffsetTop:{type:Number,default:0},onClick:{type:Function,default:void 0},onActive:{type:Function,default:void 0},isScrollElementInShadow:{type:Boolean,default:!1},syncWith:{type:String,default:"preview"},catalogMaxDepth:{type:Number,default:void 0}},_=n.defineComponent({name:"MdCatalog",props:J,emits:["onClick","onActive"],setup(e,t){const C=e.editorId,c=`#${C}-preview-wrapper`,i=n.reactive({list:[],show:!1,scrollElement:e.scrollElement||c}),k=n.shallowRef(),I=n.ref(),h=n.ref(),s=n.ref(),g=n.ref(),S=n.shallowRef(),N=n.ref({});n.provide("scrollElementRef",h),n.provide("roorNodeRef",g);const x=n.computed(()=>{const l=[];return i.list.forEach((o,d)=>{if(e.catalogMaxDepth&&o.level>e.catalogMaxDepth)return;const{text:a,level:m,line:v}=o,r={level:m,text:a,line:v,index:d+1,active:k.value===o};if(l.length===0)l.push(r);else{let E=l[l.length-1];if(r.level>E.level)for(let b=E.level+1;b<=6;b++){const{children:u}=E;if(!u){E.children=[r];break}if(E=u[u.length-1],r.level<=E.level){u.push(r);break}}else l.push(r)}}),l}),R=()=>{if(i.scrollElement instanceof HTMLElement)return i.scrollElement;let l=document;return(i.scrollElement===c||e.isScrollElementInShadow)&&(l=I.value?.getRootNode()),l.querySelector(i.scrollElement)},$=l=>{if(l.length===0)return k.value=void 0,i.list=[],!1;const{activeHead:o,activeIndex:d}=l.reduce((v,r,E)=>{let b=0;if(e.syncWith==="preview"){const u=g.value?.getElementById(e.mdHeadingId({text:r.text,level:r.level,index:E+1,currentToken:r.currentToken,nextToken:r.nextToken}));u instanceof HTMLElement&&(b=G.getRelativeTop(u,h.value))}else{const u=S.value;if(u){const A=u.lineBlockAt(u.state.doc.line(r.line+1).from).top,y=u.scrollDOM.scrollTop;b=A-y}}return b<e.offsetTop&&b>v.minTop?{activeHead:r,activeIndex:E,minTop:b}:v},{activeHead:l[0],activeIndex:0,minTop:Number.MIN_SAFE_INTEGER});let a=o;const{catalogMaxDepth:m}=e;if(m&&a.level>m){for(let v=d;v>=0;v--){const r=l[v];if(r.level<=m){a=r;break}}if(a.level>m){const v=l.find(r=>r.level<=m);v&&(a=v)}}k.value=a,i.list=l},B=(l,o)=>{N.value.top=o.offsetTop+V(o,"padding-top")+"px",e.onActive?.(l,o),t.emit("onActive",l,o)},w=()=>{$(i.list)},f=l=>{if(s.value?.removeEventListener("scroll",w),e.syncWith==="editor")s.value=S.value?.scrollDOM;else{const o=R();h.value=o,s.value=o===document.documentElement?document:o}$(l),s.value?.addEventListener("scroll",w)},p=l=>{S.value=l};return n.watch([()=>e.syncWith,S,()=>e.catalogMaxDepth],()=>{f(i.list)}),n.onMounted(()=>{g.value=I.value.getRootNode(),L.bus.on(C,{name:L.CATALOG_CHANGED,callback:f}),L.bus.on(C,{name:L.GET_EDITOR_VIEW,callback:p}),L.bus.emit(C,L.PUSH_CATALOG),L.bus.emit(C,L.SEND_EDITOR_VIEW)}),n.onBeforeUnmount(()=>{L.bus.remove(C,L.CATALOG_CHANGED,f),L.bus.remove(C,L.GET_EDITOR_VIEW,p),s.value?.removeEventListener("scroll",w)}),()=>n.createVNode("div",{class:[`${D.prefix}-catalog`,e.theme==="dark"&&`${D.prefix}-catalog-dark`,e.class||""],ref:I},[x.value.length>0&&n.createVNode(n.Fragment,null,[n.createVNode("div",{class:`${D.prefix}-catalog-indicator`,style:N.value},null),n.createVNode("div",{class:`${D.prefix}-catalog-container`},[x.value.map(l=>n.createVNode(F,{mdHeadingId:e.mdHeadingId,tocItem:l,key:`link-${l.level}-${l.text}`,onActive:B,onClick:(o,d)=>{e.onClick?.(o,d),t.emit("onClick",o,d)},scrollElementOffsetTop:e.scrollElementOffsetTop},null))])])])}});_.install=e=>(e.component(_.name,_),e);exports.MdCatalog=_;exports.scrollAuto=U;exports.scrollAutoWithScale=j;
