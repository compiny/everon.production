import{_ as G,r as d,f as Z,c as o,o as r,a as t,F as A,y as D,h as m,v as y,g as V,x as ee,l as te,i as b,t as k,b as le,A as se}from"./BWpRghuz.js";const ae={class:"product-attributes"},ne=["onUpdate:modelValue"],ie=["onUpdate:modelValue"],oe=["onClick"],re={__name:"ProductAttributes",props:{initialAttributes:{type:Array,default:()=>[]}},emits:["change"],setup(F,{expose:I,emit:g}){const w=F,S=g,u=d([...w.initialAttributes]);u.value.length===0&&u.value.push({name:"",value:""});const p=()=>u.value.filter(n=>{const a=typeof n.name=="string"?n.name.trim():"",v=typeof n.value=="string"?n.value.trim():"";return a!==""&&v!==""}).map(n=>({name:String(n.name).trim(),value:String(n.value).trim()})),U=()=>{u.value=[{name:"",value:""}],S("change",[])},C=n=>{n&&n.length>0?u.value=[...n]:u.value=[{name:"",value:""}]},f=n=>{n.preventDefault(),n.stopPropagation(),u.value.push({name:"",value:""})},x=(n,a)=>{u.value.splice(n,1),u.value.length===0&&u.value.push({name:"",value:""})};return Z(u,n=>{S("change",p())},{deep:!0}),I({getCharacteristicsForSave:p,resetCharacteristics:U,setCharacteristics:C}),(n,a)=>(r(),o("div",ae,[a[2]||(a[2]=t("h3",null,"Характеристики товара",-1)),(r(!0),o(A,null,D(u.value,(v,T)=>(r(),o("div",{key:T,class:"attribute-row"},[m(t("input",{"onUpdate:modelValue":$=>v.name=$,type:"text",placeholder:"Название характеристики",class:"attribute-name",onClick:a[0]||(a[0]=V(()=>{},["stop"]))},null,8,ne),[[y,v.name]]),m(t("input",{"onUpdate:modelValue":$=>v.value=$,type:"text",placeholder:"Значение",class:"attribute-value",onClick:a[1]||(a[1]=V(()=>{},["stop"]))},null,8,ie),[[y,v.value]]),t("button",{onClick:V($=>x(T),["stop"]),class:"remove-btn"},"×",8,oe)]))),128)),t("button",{onClick:V(f,["stop"]),class:"add-attribute-btn"},"+ Добавить характеристику")]))}},ue=G(re,[["__scopeId","data-v-c16dd7fc"]]),ce={class:"products-page"},de={class:"page-header"},pe={class:"products-list"},me={class:"product-info"},ge={class:"product-name"},ve={class:"slug"},ye={class:"price"},fe={class:"category-name"},he={key:0,class:"product-description"},_e=["innerHTML"],be={key:1,class:"product-image"},ke=["src","alt"],Ie={key:2,class:"gallery-images"},we=["src"],Ce={class:"product-actions"},$e=["onClick"],Ae=["onClick"],De={key:0,class:"modal-overlay"},Se={class:"modal"},Ue={class:"modal-header"},xe={class:"form-group"},Me={class:"form-group"},Ve={class:"form-group"},Te={class:"form-group"},Ee={key:0,class:"image-preview"},Pe=["src"],Oe={key:1,class:"image-preview"},Fe=["src"],Ne={class:"form-group"},Ge={key:0,class:"existing-gallery"},Le={class:"gallery-preview"},Je=["src"],Re=["onClick"],qe={key:1,class:"new-gallery"},Be={class:"gallery-preview"},je=["src"],He=["onClick"],We={class:"form-group"},ze={class:"form-group"},Ke={class:"form-group"},Qe={class:"form-group"},Xe=["value"],Ye={class:"form-actions"},Ze=["disabled"],et={__name:"products",setup(F){const I=d(!1),g=d(!1),w=d(!1),S=d([]),u=d([]),p=d(null),U=d(null),C=d([]),f=d([]),x=d(null),n=d(null),a=ee({id:null,name:"",slug:"",price:0,mainImage:"",gallery:"",seoTitle:"",seoDescription:"",description:"",attributes:[],categoryId:null}),v=l=>{if(!l)return"";const c=l.replace(/^###### (.*$)/gim,"<h6>$1</h6>").replace(/^##### (.*$)/gim,"<h5>$1</h5>").replace(/^#### (.*$)/gim,"<h4>$1</h4>").replace(/^### (.*$)/gim,"<h3>$1</h3>").replace(/^## (.*$)/gim,"<h2>$1</h2>").replace(/^# (.*$)/gim,"<h1>$1</h1>").split(`
`);let s="",i=!1;for(let _=0;_<c.length;_++){const E=c[_].trim();if(!E){i&&(s+="</p>",i=!1);continue}E.startsWith("<h")?(i&&(s+="</p>",i=!1),s+=E):(i?s+=" ":(s+="<p>",i=!0),s+=E)}return i&&(s+="</p>"),s},T=l=>{try{const e=JSON.parse(l);return Array.isArray(e)?e:[]}catch{return[]}},$=l=>{try{if(!l)return[];const e=JSON.parse(l);return Array.isArray(e)?e:[]}catch{return console.error("Ошибка парсинга атрибутов:",l),[]}},P=async()=>{try{const l=await $fetch("/api/products");S.value=l.products||[]}catch(l){console.error("Ошибка загрузки товаров:",l)}},L=async()=>{try{const l=await $fetch("/api/categories");u.value=l.categories||[]}catch(l){console.error("Ошибка загрузки категорий:",l)}},J=l=>{const e=u.value.find(c=>c.id===l);return e?e.name:"Без категории"},R=l=>{const e=l.target.files[0];if(e){n.value=e;const c=new FileReader;c.onload=s=>{p.value=s.target.result},c.readAsDataURL(e)}},q=()=>{p.value=null,n.value=null,U.value&&(U.value.value="")},B=()=>{a.mainImage=""},j=l=>{const e=Array.from(l.target.files);C.value.push(...e),e.forEach(c=>{const s=new FileReader;s.onload=i=>{f.value.push(i.target.result)},s.readAsDataURL(c)}),x.value&&(x.value.value="")},H=l=>{C.value.splice(l,1),f.value.splice(l,1)},W=()=>{a.name&&!a.slug&&(a.slug=a.name.toLowerCase().replace(/\s+/g,"-").replace(/[^\w-]+/g,"").replace(/--+/g,"-").trim("-"))},h=d([]),N=d([]),z=async l=>{if(Object.assign(a,{id:l.id,name:l.name,slug:l.slug,price:l.price,mainImage:l.mainImage,gallery:l.gallery,seoTitle:l.seoTitle,seoDescription:l.seoDescription,description:l.description||"",categoryId:l.categoryId,attributes:$(l.attributes)}),h.value=[],N.value=[],C.value=[],f.value=[],l.gallery){let e=[];try{e=typeof l.gallery=="string"?JSON.parse(l.gallery):l.gallery}catch(c){console.error("Error parsing gallery:",c)}Array.isArray(e)&&(h.value=e)}g.value=!0,I.value=!0,p.value=null,n.value=null},K=l=>{N.value.push(h.value[l]),h.value.splice(l,1)},Q=l=>{a.attributes=l},X=async l=>{if(confirm("Вы уверены, что хотите удалить этот товар?"))try{await $fetch(`/api/products/${l}`,{method:"DELETE"}),await P()}catch(e){console.error("Ошибка удаления товара:",e)}},M=d(null),Y=async()=>{w.value=!0;try{const l=new FormData;if(a.id&&l.append("id",a.id),l.append("name",a.name),l.append("slug",a.slug),l.append("price",String(a.price)),l.append("seoTitle",a.seoTitle||""),l.append("seoDescription",a.seoDescription||""),l.append("description",a.description||""),l.append("existingGallery",JSON.stringify(h.value)),M.value){const i=M.value.getCharacteristicsForSave();l.append("attributes",JSON.stringify(i))}else l.append("attributes",JSON.stringify([]));a.categoryId!==null&&l.append("categoryId",String(a.categoryId)),n.value&&l.append("mainImage",n.value),C.value.forEach(i=>{l.append("galleryFiles",i)});const e=g.value?`/api/products/${a.id}`:"/api/products",c=g.value?"PUT":"POST",s=await $fetch(e,{method:c,body:l});O(),await P()}catch(l){console.error("Ошибка сохранения товара:",l),alert(l.data?.message||"Ошибка при сохранении товара")}finally{w.value=!1}},O=()=>{I.value=!1,g.value=!1,p.value=null,n.value=null,Object.assign(a,{id:null,name:"",slug:"",price:0,mainImage:"",gallery:"",seoTitle:"",seoDescription:"",description:"",attributes:[],categoryId:null}),M.value&&M.value.resetCharacteristics()};return te(()=>{P(),L()}),(l,e)=>{const c=ue;return r(),o("div",ce,[t("div",de,[e[8]||(e[8]=t("h1",null,"Товары",-1)),t("button",{onClick:e[0]||(e[0]=s=>I.value=!0),class:"add-btn"},"+ Добавить")]),t("div",pe,[(r(!0),o(A,null,D(S.value,s=>(r(),o("div",{key:s.id,class:"product-item"},[t("div",me,[t("span",ge,k(s.name),1),t("span",ve,"("+k(s.slug)+")",1),t("span",ye,k(s.price)+" ₽",1),t("span",fe,"Категория: "+k(J(s.categoryId)),1),s.description?(r(),o("div",he,[t("div",{innerHTML:v(s.description)},null,8,_e)])):b("",!0),e[10]||(e[10]=t("div",null,"Главное фото:",-1)),s.mainImage?(r(),o("div",be,[t("img",{src:s.mainImage,alt:s.name},null,8,ke)])):b("",!0),s.gallery?(r(),o("div",Ie,[e[9]||(e[9]=t("div",null,"Галерея:",-1)),(r(!0),o(A,null,D(T(s.gallery),(i,_)=>(r(),o("img",{key:_,src:i,alt:"Gallery image",class:"gallery-img"},null,8,we))),128))])):b("",!0)]),t("div",Ce,[t("button",{onClick:i=>z(s),class:"edit-btn"},"Редактировать",8,$e),t("button",{onClick:i=>X(s.id),class:"delete-btn"},"Удалить",8,Ae)])]))),128))]),I.value?(r(),o("div",De,[t("div",Se,[t("div",Ue,[t("h3",null,k(g.value?"Редактировать":"Новый")+" товар",1),t("button",{onClick:O},"×")]),t("form",{onSubmit:V(Y,["prevent"]),class:"modal-form",enctype:"multipart/form-data"},[t("div",xe,[e[11]||(e[11]=t("label",null,"Название *",-1)),m(t("input",{"onUpdate:modelValue":e[1]||(e[1]=s=>a.name=s),required:"",onInput:W},null,544),[[y,a.name]])]),t("div",Me,[e[12]||(e[12]=t("label",null,"ЧПУ для товара *",-1)),m(t("input",{"onUpdate:modelValue":e[2]||(e[2]=s=>a.slug=s),placeholder:"product-slug",required:""},null,512),[[y,a.slug]])]),t("div",Ve,[e[13]||(e[13]=t("label",null,"Цена (в ₽) *",-1)),m(t("input",{type:"number","onUpdate:modelValue":e[3]||(e[3]=s=>a.price=s),required:"",min:"0"},null,512),[[y,a.price,void 0,{number:!0}]])]),t("div",Te,[e[14]||(e[14]=t("label",null,"Главное изображение",-1)),t("input",{type:"file",accept:"image/*",onChange:R,ref_key:"mainImageInput",ref:U},null,544),p.value?(r(),o("div",Ee,[t("img",{src:p.value,alt:"Preview"},null,8,Pe),t("button",{type:"button",onClick:q,class:"remove-image-btn"},"×")])):a.mainImage?(r(),o("div",Oe,[t("img",{src:a.mainImage,alt:"Current image"},null,8,Fe),t("button",{type:"button",onClick:B,class:"remove-image-btn"},"×")])):b("",!0)]),t("div",Ne,[e[17]||(e[17]=t("label",null,"Галерея",-1)),t("input",{type:"file",multiple:"",accept:"image/*",onChange:j,ref_key:"galleryInput",ref:x},null,544),h.value.length>0?(r(),o("div",Ge,[e[15]||(e[15]=t("h4",null,"Существующие изображения:",-1)),t("div",Le,[(r(!0),o(A,null,D(h.value,(s,i)=>(r(),o("div",{key:"existing-"+i,class:"image-preview"},[t("img",{src:s,alt:"Existing gallery image"},null,8,Je),t("button",{type:"button",onClick:_=>K(i),class:"remove-image-btn"},"×",8,Re)]))),128))])])):b("",!0),f.value.length>0?(r(),o("div",qe,[e[16]||(e[16]=t("h4",null,"Новые изображения:",-1)),t("div",Be,[(r(!0),o(A,null,D(f.value,(s,i)=>(r(),o("div",{key:"new-"+i,class:"image-preview"},[t("img",{src:s,alt:"Gallery image preview"},null,8,je),t("button",{type:"button",onClick:_=>H(i),class:"remove-image-btn"},"×",8,He)]))),128))])])):b("",!0)]),le(c,{ref_key:"productAttributesRef",ref:M,"initial-attributes":a.attributes,onChange:Q},null,8,["initial-attributes"]),t("div",We,[e[18]||(e[18]=t("label",null,"SEO Title",-1)),m(t("input",{"onUpdate:modelValue":e[4]||(e[4]=s=>a.seoTitle=s),maxlength:"255"},null,512),[[y,a.seoTitle]])]),t("div",ze,[e[19]||(e[19]=t("label",null,"SEO Description",-1)),m(t("textarea",{"onUpdate:modelValue":e[5]||(e[5]=s=>a.seoDescription=s),rows:"3",maxlength:"500"},null,512),[[y,a.seoDescription]])]),t("div",Ke,[e[20]||(e[20]=t("label",null,"Описание товара (Markdown)",-1)),m(t("textarea",{"onUpdate:modelValue":e[6]||(e[6]=s=>a.description=s),rows:"8",placeholder:"Введите описание товара с использованием Markdown...",class:"markdown-textarea"},null,512),[[y,a.description]]),e[21]||(e[21]=t("div",{class:"markdown-hint"},[t("small",null,"Поддерживается Markdown: заголовки и параграфы")],-1))]),t("div",Qe,[e[23]||(e[23]=t("label",null,"Категория",-1)),m(t("select",{"onUpdate:modelValue":e[7]||(e[7]=s=>a.categoryId=s)},[e[22]||(e[22]=t("option",{value:null},"Без категории",-1)),(r(!0),o(A,null,D(u.value,s=>(r(),o("option",{key:s.id,value:s.id},k(s.name),9,Xe))),128))],512),[[se,a.categoryId]])]),t("div",Ye,[t("button",{type:"submit",disabled:w.value},k(w.value?"Загрузка...":g.value?"Обновить":"Сохранить"),9,Ze),t("button",{type:"button",onClick:O},"Отмена")])],32)])])):b("",!0)])}}},lt=G(et,[["__scopeId","data-v-dd22b93c"]]);export{lt as default};
