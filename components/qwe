<template>
    <div class="search-container">
        <form class="search-form" @submit.prevent="performSearch" ref="searchForm">
            <input 
                class="search-inp" 
                type="text" 
                placeholder="–ü–æ–∏—Å–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π..."
                v-model="searchQuery"
                @input="handleInput"
                @focus="showSuggestions = true"
                @blur="onBlur"
                ref="searchInput"
            >
            <button class="search-btn" type="submit">üîç</button>
            
            <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∏ -->
            <div v-if="showSuggestions && searchQuery.length >= 2" class="search-suggestions">
                <div v-if="isLoadingSuggestions" class="suggestion-item">
                    –ü–æ–∏—Å–∫...
                </div>
                <div v-else-if="suggestions.length === 0" class="suggestion-item">
                    –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                </div>
                <div 
                    v-for="suggestion in suggestions" 
                    :key="suggestion.id"
                    class="suggestion-item suggestion-category"
                    @mousedown="selectSuggestion(suggestion)"
                >
                    <span class="suggestion-title">üìÅ {{ suggestion.title }}</span>
                    <span class="suggestion-type">–∫–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                </div>
            </div>
        </form>
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ -->
        <SearchResults 
            v-if="showSearchResults"
            :search-query="searchQuery"
            :results="searchResults"
            @close="closeSearchResults"
            @navigate="navigateTo"
        />
    </div>
</template>

<script setup>
const searchQuery = ref('')
const showSuggestions = ref(false)
const suggestions = ref([])
const isLoadingSuggestions = ref(false)

let searchTimeout = null

const onBlur = () => {
  setTimeout(() => {
    showSuggestions.value = false
  }, 200)
}

const handleInput = () => {
  if (searchQuery.value.length >= 2) {
    showSuggestions.value = true
    clearTimeout(searchTimeout)
    searchTimeout = setTimeout(() => {
      loadSuggestions()
    }, 300)
  } else {
    showSuggestions.value = false
    suggestions.value = []
  }
}

const loadSuggestions = async () => {
  if (searchQuery.value.length < 2) return
  
  isLoadingSuggestions.value = true
  try {
    const data = await $fetch('/api/search', {
      params: { 
        q: searchQuery.value, 
        limit: 5 
      }
    })
    
    suggestions.value = data.categories.map(category => ({
      id: category.id,
      title: category.name,
      type: '–∫–∞—Ç–µ–≥–æ—Ä–∏—è',
      url: `/catalog/${category.slug}`,
      description: category.description
    }))
    
  } catch (error) {
    console.error('Error loading suggestions:', error)
    suggestions.value = []
  } finally {
    isLoadingSuggestions.value = false
  }
}

const performSearch = () => {
  if (searchQuery.value.trim()) {
    navigateTo(`/search?q=${encodeURIComponent(searchQuery.value)}`)
    showSuggestions.value = false
  }
}

const selectSuggestion = (suggestion) => {
  searchQuery.value = suggestion.title
  showSuggestions.value = false
  navigateTo(suggestion.url)
}
</script>

<style scoped>
.search-container {
  position: relative;
}

.search-suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  z-index: 1000;
  max-height: 300px;
  overflow-y: auto;
}

.suggestion-item {
  padding: 10px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #f0f0f0;
}

.suggestion-item:hover {
  background-color: #f5f5f5;
}

.suggestion-category {
  background-color: #f8f9fa;
}

.suggestion-title {
  font-weight: 500;
}

.suggestion-type {
  font-size: 12px;
  color: #666;
  background: #e9ecef;
  padding: 2px 6px;
  border-radius: 12px;
}
</style>